{% extends "base.html" %}

{% block title %}Valdymo Panelƒó - Atsiliepimai+{% endblock %}

{% block content %}
        <!-- Pagrindinis Turinys -->
        <main class="flex-1 overflow-y-auto">
            
            <!-- Vir≈°utinƒó juosta (su "Menu" mygtuku mobiliesiems) -->
            <header class="bg-white shadow-sm p-4 flex justify-between items-center">
                <!-- Mobilus Meniu Mygtukas -->
                <button class="md:hidden p-2 text-gray-600">
                    <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" /></svg>
                </button>
                
                <h1 class="text-2xl font-bold text-gray-800 hidden md:block">
                    Sveiki, {{ user.first_name }}! üëã
                </h1>
                
                <a href="#" id="request-feedback-btn" class="px-4 py-2 text-sm font-medium text-white bg-purple-500 rounded-lg shadow-sm hover:bg-purple-600 transition-colors">
                    Pra≈°yti feedback'o
                </a>
            </header>

            <!-- Turinys -->
            <div class="p-6 md:p-8 space-y-6">

                <!-- 2.1. Statistikos Kortelƒós -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-white p-6 rounded-2xl shadow-lg flex items-center space-x-4">
                        <div class="bg-purple-100 p-3 rounded-full">
                            <svg class="w-6 h-6 text-purple-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6h9.75M10.5 6a1.5 1.5 0 1 1-3 0m3 0a1.5 1.5 0 1 0-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m-3.75 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m-9.75 0h9.75" /></svg>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">Laukianƒçios U≈æduotys</p>
                            <p class="text-2xl font-bold text-gray-800">3</p>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-lg flex items-center space-x-4">
                        <div class="bg-purple-100 p-3 rounded-full">
                            <svg class="w-6 h-6 text-purple-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m4.5 12.75 6 6 9-13.5" /></svg>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">U≈æpildytos Apklausos</p>
                            <p class="text-2xl font-bold text-gray-800">12</p>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-lg flex items-center space-x-4">
                        <div class="bg-purple-100 p-3 rounded-full">
                            <svg class="w-6 h-6 text-purple-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M18 18.72a9.094 9.094 0 0 0 3.741-.479 3 3 0 0 0-4.998-2.55m-3.002 2.55a9.094 9.094 0 0 1-3.741-.479 3 3 0 0 1-4.998-2.55m3.002 2.55a9.094 9.094 0 0 0 3.741-.479 3 3 0 0 0 4.998-2.55m-3.002 2.55a3 3 0 0 1-4.998-2.55m0 0a9.094 9.094 0 0 1-3.741-.479 3 3 0 0 1-4.998-2.55M12 9.75a3 3 0 0 1 0-3 3 3 0 0 1 0 3z" /></svg>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">Mano Komanda</p>
                            <p class="text-2xl font-bold text-gray-800">8</p>
                        </div>
                    </div>
                </div>

                <!-- 2.2. Turinys (2 stulpeliai) -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    
                    <!-- Kairys stulpelis (U≈æduotys) -->
                    <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-lg">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">Mano U≈æduotys</h3>
                        <div class="space-y-4">
                            {% if feedback_requests %}
                                {% for fr in feedback_requests %}
                                    <div class="border rounded-lg p-4 flex justify-between items-center">
                                        <div>
                                            <h4 class="font-semibold text-gray-800">{{ fr.project_name }}</h4>
                                            <p class="text-sm text-gray-500">Pateikƒó: {{ fr.requester.first_name }} {{ fr.requester.last_name }} | Iki: {{ fr.due_date }}</p>
                                        </div>
                                        <a href="{% url 'fill_feedback' fr.id %}" class="px-4 py-2 text-sm font-medium text-white bg-purple-500 rounded-lg shadow-sm hover:bg-purple-600">
                                            Pildyti
                                        </a>
                                    </div>
                                {% endfor %}
                            {% else %}
                                <p>Neturite joki≈≥ u≈æduoƒçi≈≥.</p>
                            {% endif %}
                        </div>
                    </div>

                    <!-- De≈°inys stulpelis (Aktyvumas) -->
                    <div class="bg-white p-6 rounded-2xl shadow-lg">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">Komandos Aktyvumas</h3>
                        <ul class="space-y-3">
                            <li class="flex items-center space-x-3">
                                <img class="w-8 h-8 rounded-full" src="https://placehold.co/40x40/ecc94b/333?text=JA" alt="J.A.">
                                <p class="text-sm text-gray-600"><span class="font-semibold">Jonas Antanaitis</span> pateikƒó atsiliepimƒÖ apie jus.</p>
                            </li>
                            <li class="flex items-center space-x-3">
                                <img class="w-8 h-8 rounded-full" src="https://placehold.co/40x40/9f7aea/333?text=LP" alt="L.P.">
                                <p class="text-sm text-gray-600"><span class="font-semibold">Lina Petraitienƒó</span> pradƒójo "Ketvirƒçio 360¬∞" apklausƒÖ.</p>
                            </li>
                            <li class="flex items-center space-x-3">
                                <img class="w-8 h-8 rounded-full" src="https://placehold.co/40x40/48bb78/333?text=KS" alt="K.S.">
                                <p class="text-sm text-gray-600"><span class="font-semibold">Kƒôstas S</span> papra≈°ƒó j≈´s≈≥ atsiliepimo.</p>
                            </li>
                        </ul>
                    </div>

                </div>
            </div>
        </main>

    <div id="feedback-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900">Pra≈°yti Feedback'o</h3>
                <div class="mt-2 px-7 py-3">
                    <form id="feedback-form">
                                                        {% csrf_token %}
                                                        <div class="mb-4">
                                                            <label for="team-member" class="block text-sm font-medium text-gray-700">Komandos narys</label>
                                                            <select id="team-member" name="requested_to" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                                                <!-- Options will be populated by JavaScript -->
                                                            </select>
                                                        </div>
                                                        <div class="mb-4">
                                                            <label for="project-name" class="block text-sm font-medium text-gray-700">Projekto pavadinimas</label>
                                                            <input type="text" name="project_name" id="project-name" class="mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
                                                        </div>
                                                        <div class="mb-4">
                                                            <label for="due-date" class="block text-sm font-medium text-gray-700">Pateikti iki</label>
                                                            <input type="date" name="due_date" id="due-date" class="mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
                                                        </div>
                                                        <div class="items-center px-4 py-3">
                                                            <button id="submit-feedback" class="px-4 py-2 bg-purple-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-purple-600 focus:outline-none focus:ring-2 focus:ring-purple-300">
                                                                Pateikti
                                                            </button>
                                                        </div>
                                                    </form>                </div>
                <div class="items-center px-4 py-3">
                    <button id="close-modal" class="px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-300">
                        U≈ædaryti
                    </button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
<script>
    const feedbackModal = document.getElementById('feedback-modal');
    const requestFeedbackBtn = document.getElementById('request-feedback-btn');
    const closeModalBtn = document.getElementById('close-modal');
    const teamMemberSelect = document.getElementById('team-member');
    const feedbackForm = document.getElementById('feedback-form');

    requestFeedbackBtn.addEventListener('click', () => {
        fetch("{% url 'get_team_members' %}")
            .then(response => response.json())
            .then(data => {
                teamMemberSelect.innerHTML = '';
                data.forEach(member => {
                    const option = document.createElement('option');
                    option.value = member.id;
                    option.textContent = member.name;
                    teamMemberSelect.appendChild(option);
                });
            });
        feedbackModal.classList.remove('hidden');
    });

    closeModalBtn.addEventListener('click', () => {
        feedbackModal.classList.add('hidden');
    });

    feedbackForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const formData = new FormData(feedbackForm);
        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        formData.append('csrfmiddlewaretoken', csrftoken);

        fetch("{% url 'request_feedback' %}", {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': csrftoken
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                feedbackModal.classList.add('hidden');
                // Optionally, show a success message
            } else {
                // Handle errors
                console.error(data.errors);
            }
        });
    });
</script>
{% endblock %}